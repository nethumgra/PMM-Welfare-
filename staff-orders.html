<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - PMM Welfare Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F0FDF4; }
        ::-webkit-scrollbar-thumb { background: #059669; border-radius: 10px; }
        .table-container { scrollbar-width: thin; scrollbar-color: #059669 #F0FDF4; }
    </style>
</head>
<body class="bg-[#F0FDF4] text-[#064E3B] font-sans">

    <nav class="p-6 flex justify-between items-center max-w-7xl mx-auto">
        <h1 class="text-2xl font-black italic text-[#059669] cursor-pointer" onclick="location.href='products.html'">PMM Welfare.</h1>
        <div class="flex gap-4 items-center">
            <div class="text-right">
                <p id="displayStaffName" class="font-bold text-sm text-[#064E3B]">Staff User</p>
                <p id="displayPosition" class="text-[10px] text-[#059669] font-black uppercase tracking-widest">Role</p>
            </div>
            <button onclick="location.href='products.html'" class="bg-white p-3 rounded-2xl shadow-sm border border-[#DCFCE7] text-[#059669] hover:bg-white/50 transition">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-10">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="bg-white p-6 rounded-[2.5rem] border border-[#DCFCE7] shadow-sm">
                <p class="text-[10px] font-black text-[#059669] uppercase tracking-widest mb-2">Monthly Budget Used</p>
                <h3 class="text-2xl font-black text-[#064E3B]" id="budgetUsedDisplay">Rs. 0.00</h3>
                <div class="w-full bg-[#F0FDF4] h-2 rounded-full mt-3 overflow-hidden">
                    <div id="budgetBar" class="bg-[#059669] h-full transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-[2.5rem] border border-[#DCFCE7] shadow-sm">
                <p class="text-[10px] font-black text-[#059669] uppercase tracking-widest mb-2">Total Welfare Savings</p>
                <h3 class="text-2xl font-black text-emerald-600" id="totalSavingsDisplay">Rs. 0.00</h3>
                <p class="text-[10px] text-emerald-600 font-bold mt-2 uppercase">Your Profit (From Dispatched Items)</p>
            </div>
            <div class="bg-white p-6 rounded-[2.5rem] border border-[#DCFCE7] shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-[10px] font-black text-[#059669] uppercase tracking-widest">Items Dispatched</p>
                    <h3 class="text-2xl font-black text-[#064E3B]" id="orderCountDisplay">0</h3>
                </div>
                <div class="bg-[#F0FDF4] p-4 rounded-3xl text-[#059669]"><i data-lucide="shopping-bag"></i></div>
            </div>
        </div>

        <div class="bg-white rounded-[3rem] shadow-xl border border-[#DCFCE7] overflow-hidden">
            <div class="p-8 border-b border-[#F0FDF4] flex justify-between items-center">
                <h3 class="text-xl font-black text-[#064E3B]">Purchase History</h3>
                <i data-lucide="history" class="text-[#059669]"></i>
            </div>
            <div class="overflow-x-auto table-container">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-[#F0FDF4] text-[#059669] text-[10px] uppercase tracking-widest">
                            <th class="p-8">Date</th>
                            <th class="p-8">Item Details</th>
                            <th class="p-8">Active Total</th>
                            <th class="p-8">Active Saving</th>
                            <th class="p-8 text-center">Status</th>
                            <th class="p-8 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="staffOrdersBody" class="text-sm font-medium text-[#064E3B]"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, getDocs, doc, updateDoc, increment, addDoc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3jlpc_vbUydda2XpDj5Xd1J8kVei9v8U",
            authDomain: "inventory-c3cca.firebaseapp.com",
            projectId: "inventory-c3cca",
            storageBucket: "inventory-c3cca.firebasestorage.app",
            messagingSenderId: "396140403894",
            appId: "1:396140403894:web:316617b8e390f8b0575a17"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const staffId = sessionStorage.getItem('staffId');
        const staffName = sessionStorage.getItem('staffName');
        const userPosition = sessionStorage.getItem('userPosition');

        document.getElementById('displayStaffName').innerText = staffName;
        document.getElementById('displayPosition').innerText = userPosition;
async function loadMyOrders() {
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    let budgetLimit = 0;

    // --- 1. බජට් සීමාව ලබා ගැනීම (Individual Override මුලින්ම පරීක්ෂා කරයි) ---
    try {
        const userDoc = await getDoc(doc(db, "users", staffId));
        if (userDoc.exists() && userDoc.data().monthlyLimit > 0) {
            budgetLimit = userDoc.data().monthlyLimit;
        } else {
            // විශේෂිත ලිමිට් එකක් නැත්නම් Role එකේ Default ලිමිට් එක ගනියි
            const rolesSnap = await getDocs(collection(db, "roles"));
            const matchingRole = rolesSnap.docs.find(d => 
                d.data().name.toLowerCase().trim() === userPosition.toLowerCase().trim()
            );
            budgetLimit = matchingRole ? matchingRole.data().monthlyLimit : 0;
        }
    } catch (e) { console.error("Budget Loading Error:", e); }

    // --- 2. ඇණවුම් නිරීක්ෂණය (Real-time Snapshot) ---
    const q = query(collection(db, "orders"), where("staffId", "==", staffId), orderBy("createdAt", "desc"));
    
    onSnapshot(q, (snap) => {
        const tableBody = document.getElementById('staffOrdersBody');
        tableBody.innerHTML = '';
        let spentThisMonth = 0;
        let savingsThisMonth = 0;
        let totalItemsCount = 0;

        snap.forEach(d => {
            const order = d.data();
            const orderId = d.id;
            const orderDate = order.createdAt?.toDate();
            const status = order.status || "Pending";

            let rowActiveTotal = 0;
            let rowActiveSaving = 0;

            // ඇණවුමේ ඇති අයිතම එකින් එක පරීක්ෂා කිරීම
            const itemsListHtml = order.items.map(item => {
                const isRejected = item.status === "Rejected";
                
                // Rejected අයිතම සඳහා මිල 0 ලෙස ගනියි (එය බජට් එකට බලපාන්නේ නැත)
                const itemPrice = isRejected ? 0 : (item.welfarePrice * item.qty);
                const itemSaving = isRejected ? 0 : ((item.mrpPrice - item.welfarePrice) * item.qty);

                rowActiveTotal += itemPrice;
                rowActiveSaving += itemSaving;

                // මාසික වාර්තා (Stats): Cancelled නොවන සහ Rejected නොවන අයිතම පමණක් ගණනය කරයි
                if (orderDate >= startOfMonth && status !== "Cancelled" && !isRejected) {
                    spentThisMonth += itemPrice;
                    savingsThisMonth += itemSaving;
                    // අයිතම සංඛ්‍යාව ගණනය කරන්නේ Dispatched/Completed ඒවා සඳහා පමණි
                    if(item.status === "Dispatched" || item.status === "Completed") {
                        totalItemsCount += item.qty;
                    }
                }

                let itemStatusColor = "text-amber-500";
                if(item.status === "Dispatched" || item.status === "Completed") itemStatusColor = "text-blue-600";
                if(isRejected) itemStatusColor = "text-red-500";

                return `
                    <div class="flex justify-between text-[10px] mb-1 pb-1 border-b border-gray-50 last:border-0">
                        <span class="${isRejected ? 'line-through text-red-400' : 'font-bold'}">${item.name} (x${item.qty})</span>
                        <span class="font-black uppercase ${itemStatusColor}">
                            ${item.status || 'Pending'} ${isRejected ? '' : '- Rs.' + itemPrice.toLocaleString()}
                        </span>
                    </div>
                `;
            }).join('');

            let statusStyle = "bg-amber-100 text-amber-600";
            if(status === "Completed") statusStyle = "bg-green-100 text-green-700";
            else if(status === "Dispatched") statusStyle = "bg-blue-100 text-blue-600";
            else if(status === "Cancelled") statusStyle = "bg-red-100 text-red-600";

            const hasDispatchedItems = order.items.some(i => i.status === "Dispatched" || i.status === "Completed");

            tableBody.innerHTML += `
                <tr class="border-b border-[#F0FDF4] hover:bg-[#F0FDF4]/50 transition">
                    <td class="p-8 text-[11px] font-bold text-[#059669]">${orderDate?.toLocaleDateString()}</td>
                    <td class="p-8">
                        <p class="font-black text-[#064E3B] mb-2 uppercase text-sm tracking-widest">${order.orderNo || 'Pack #' + orderId.substring(0,8)}</p>
                        <div class="bg-gray-50 p-3 rounded-2xl border border-gray-100">${itemsListHtml}</div>
                    </td>
                    <td class="p-8 font-black text-[#064E3B]">Rs. ${rowActiveTotal.toLocaleString()}</td>
                    <td class="p-8 font-black text-emerald-600 italic">Rs. ${rowActiveSaving.toLocaleString()}</td>
                    <td class="p-8 text-center">
                        <span class="px-4 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest ${statusStyle}">
                            ${status}
                        </span>
                    </td>
                    <td class="p-8 text-right">
                        <div class="flex flex-col gap-2 items-end">
                            ${hasDispatchedItems ? `
                                <button onclick="window.downloadDispatchedInvoice('${orderId}')" 
                                        class="bg-blue-600 text-white px-3 py-2 rounded-xl font-black text-[9px] uppercase hover:bg-blue-700 transition flex items-center gap-1 shadow-md">
                                    <i data-lucide="download" class="w-3 h-3"></i> Download Invoice
                                </button>
                            ` : ''}
                            ${status === "Pending" ? `
                                <button onclick="window.cancelOrderPack('${orderId}')" 
                                        class="text-red-500 hover:text-red-700 transition flex items-center gap-1 font-bold text-[10px] uppercase">
                                    <i data-lucide="x-circle" class="w-4 h-4"></i> Cancel Pack
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>`;
        });

        // Header Stats යාවත්කාලීන කිරීම
        document.getElementById('budgetUsedDisplay').innerText = `Rs. ${spentThisMonth.toLocaleString()} / ${budgetLimit.toLocaleString()}`;
        document.getElementById('totalSavingsDisplay').innerText = `Rs. ${savingsThisMonth.toLocaleString()}`;
        document.getElementById('orderCountDisplay').innerText = totalItemsCount; 
        
        // Progress Bar එක යාවත්කාලීන කිරීම
        const percent = budgetLimit > 0 ? (spentThisMonth / budgetLimit) * 100 : 0;
        const bar = document.getElementById('budgetBar');
        bar.style.width = Math.min(percent, 100) + "%";
        
        // බජට් එක 90% ඉක්මවා ගියහොත් රතු පැහැයෙන් පෙන්වයි
        if(percent > 90) bar.className = "bg-red-500 h-full transition-all duration-1000";
        else bar.className = "bg-[#059669] h-full transition-all duration-1000";

        lucide.createIcons();
    });
}

        // --- Optimized Dispatched Invoice PDF Generator ---
        window.downloadDispatchedInvoice = async (orderId) => {
            const orderRef = doc(db, "orders", orderId);
            const snap = await getDoc(orderRef);
            if (!snap.exists()) return;
            
            const order = snap.data();
            const dispatchedItems = order.items.filter(i => i.status === "Dispatched" || i.status === "Completed");

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ unit: 'mm', format: [100, 150] });

            // Header Section
            pdf.setFont("helvetica", "bold");
            pdf.setTextColor(5, 150, 105); 
            pdf.text("PMM WELFARE RECEIPT", 50, 15, { align: "center" });

            pdf.setTextColor(0, 0, 0); pdf.setFontSize(9);
            pdf.text(`Order No: #${order.orderNo || orderId.substring(0,8)}`, 10, 30);
            pdf.text(`Staff: ${order.staffName}`, 10, 36);
            pdf.text(`Date: ${new Date().toLocaleDateString()}`, 10, 42);

            pdf.line(10, 46, 90, 46);
            let y = 54;
            let dispatchedTotal = 0;
            let dispatchedSavings = 0;

            // Items List in PDF
            dispatchedItems.forEach(item => {
                const subTotal = item.welfarePrice * item.qty;
                dispatchedTotal += subTotal;
                dispatchedSavings += ((item.mrpPrice - item.welfarePrice) * item.qty);

                pdf.setFontSize(8);
                pdf.setFont("helvetica", "bold");
                pdf.text(`${item.name} (x${item.qty})`, 10, y);
                
                pdf.setFont("helvetica", "normal");
                pdf.setFontSize(7);
                pdf.text(`${item.qty} x Rs. ${item.welfarePrice.toLocaleString()}`, 10, y + 4);
                
                pdf.setFontSize(8);
                pdf.text(`Rs. ${subTotal.toLocaleString()}`, 90, y, { align: "right" });
                y += 10;
            });

            pdf.line(10, y, 90, y);
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(10);
            pdf.text(`TOTAL PAID: Rs. ${dispatchedTotal.toLocaleString()}`, 10, y + 8);
            
            pdf.setTextColor(5, 150, 105);
            pdf.setFontSize(9);
            pdf.text(`Welfare Savings: Rs. ${dispatchedSavings.toLocaleString()}`, 10, y + 14);

            pdf.setFontSize(7);
            pdf.setTextColor(150, 150, 150);
            pdf.text("Thank you for using PMM Welfare Service!", 50, 140, { align: "center" });

            pdf.save(`Receipt_${order.orderNo || orderId.substring(0,5)}.pdf`);
        };

        
       window.cancelOrderPack = async (orderId) => {
    if (!confirm(`Are you sure you want to cancel this entire pack? Stock will be restored.`)) return;
    
    try {
        const orderRef = doc(db, "orders", orderId);
        const orderSnap = await getDoc(orderRef);
        const orderData = orderSnap.data();

        // 1. මුලින්ම Order Status එක Cancelled කරනවා
        await updateDoc(orderRef, { status: "Cancelled" });

        // 2. පැක් එකේ තියෙන හැම අයිටම් එකක්ම ලූප් එකක් හරහා ස්ටොක් එකට එකතු කරනවා
        for (const item of orderData.items) {
            const itemRef = doc(db, "items", item.itemId);
            
            // ස්ටොක් එක වැඩි කරනවා
            await updateDoc(itemRef, { stock: increment(item.qty) });

            // **වැදගත්ම කොටස**: ස්ටොක් එක අප්ඩේට් වුණාට පස්සේ අලුත් බැලන්ස් එක ගන්නවා
            const updatedSnap = await getDoc(itemRef);
            const currentBalance = updatedSnap.exists() ? updatedSnap.data().stock : 0;

            // 3. Bin Card එකට (inventory_logs) දත්ත ඇතුළත් කරනවා
            await addDoc(collection(db, "inventory_logs"), {
                itemId: item.itemId,
                itemName: item.name,
                type: "RETURN", // ටයිප් එක රිටර්න් ලෙස
                qty: item.qty,
                balance: currentBalance, // දැන් මෙතනට Err වෙනුවට නිවැරදි අගය වැටෙනවා
                processedBy: "Staff (Auto-Cancel)",
                createdAt: new Date(),
                orderNo: orderData.orderNo || "N/A", // බින් කාඩ් එකේ පෙන්වීමට ඕඩර් නම්බර් එක
                note: `Order #${orderData.orderNo} was cancelled by user.`
            });
        }
        alert("Order Pack cancelled and stock restored successfully!");
    } catch (e) { 
        alert("Cancellation Error: " + e.message); 
    }
};
        loadMyOrders();
        lucide.createIcons();
    </script>
</body>
</html>